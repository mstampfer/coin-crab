name: Deploy Server to AWS EC2 (UAT)

on:
  push:
    branches: [ uat ]
    paths:
      - 'crates/server/**'
      - 'crates/shared/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  pull_request:
    branches: [ uat ]
    paths:
      - 'crates/server/**'
      - 'crates/shared/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  workflow_dispatch:  # Enable manual trigger from GitHub UI

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Check workspace
      run: cargo check --workspace
      
    - name: Run server tests
      run: cargo test -p coin-crab-server --verbose
      
    - name: Run shared crate tests  
      run: cargo test -p shared --verbose
      
    - name: Build server for release
      run: |
        # Install cross-compilation tools for ARM64
        sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu
        
        # Set environment variables for cross-compilation
        export CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
        export CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++
        export AR_aarch64_unknown_linux_gnu=aarch64-linux-gnu-ar
        export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
        
        # Use rustls instead of OpenSSL to avoid cross-compilation issues
        export CARGO_NET_GIT_FETCH_WITH_CLI=true
        
        # Add Rust target for ARM64
        rustup target add aarch64-unknown-linux-gnu
        
        # Build for ARM64 (using rustls instead of OpenSSL)
        cargo build -p coin-crab-server --release --target aarch64-unknown-linux-gnu
        
        # Debug: show binary info
        file target/aarch64-unknown-linux-gnu/release/coin-crab-server
        ls -la target/aarch64-unknown-linux-gnu/release/coin-crab-server
      
    - name: Upload server binary as artifact
      uses: actions/upload-artifact@v4
      with:
        name: coin-crab-server-binary
        path: target/aarch64-unknown-linux-gnu/release/coin-crab-server
        retention-days: 7

  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/uat' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download server binary
      uses: actions/download-artifact@v4
      with:
        name: coin-crab-server-binary
        path: ./artifacts
        
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AWS_SSH_PRIVATE_KEY }}" > ~/.ssh/aws-freetier.pem
        chmod 600 ~/.ssh/aws-freetier.pem
        ssh-keyscan -H 100.26.107.175 >> ~/.ssh/known_hosts
        
    - name: Copy server files to EC2
      run: |
        # Create UAT directory on EC2
        ssh -i ~/.ssh/aws-freetier.pem ec2-user@100.26.107.175 "mkdir -p coin_crab_server/uat"
        
        # Copy binary to UAT directory
        scp -i ~/.ssh/aws-freetier.pem ./artifacts/coin-crab-server ec2-user@100.26.107.175:~/coin_crab_server/uat/
        
        # Copy configuration files to UAT directory
        scp -i ~/.ssh/aws-freetier.pem crates/server/.env.server ec2-user@100.26.107.175:~/coin_crab_server/uat/ || echo "No .env.server file found - you'll need to create it manually on the server"
        scp -i ~/.ssh/aws-freetier.pem crates/server/rumqttd.toml ec2-user@100.26.107.175:~/coin_crab_server/uat/
        
    - name: Deploy and restart UAT server
      run: |
        ssh -i ~/.ssh/aws-freetier.pem ec2-user@100.26.107.175 << 'EOF'
          cd coin_crab_server/uat
          
          # Debug: Check system architecture and binary format
          echo "🔍 EC2 System Info (UAT):"
          uname -m
          file coin-crab-server
          
          # Make binary executable
          chmod +x coin-crab-server
          
          # Stop existing UAT server if running (look for processes in uat directory)
          pkill -f "coin_crab_server/uat/coin-crab-server" || echo "No existing UAT server process found"
          
          # Wait a moment for graceful shutdown
          sleep 2
          
          # Start UAT server in background with nohup
          # Redirect output to log file
          nohup ./coin-crab-server > server.log 2>&1 &
          
          # Save PID for future management
          echo $! > server.pid
          
          # Wait a moment and check if server started
          sleep 3
          if ps -p $(cat server.pid) > /dev/null 2>&1; then
            echo "UAT server started successfully with PID $(cat server.pid)"
            echo "UAT server status:"
            ps -p $(cat server.pid) -o pid,ppid,cmd
          else
            echo "UAT server failed to start"
            echo "Last 20 lines of UAT server log:"
            tail -20 server.log
            exit 1
          fi
        EOF
        
    - name: Verify UAT deployment
      run: |
        ssh -i ~/.ssh/aws-freetier.pem ec2-user@100.26.107.175 << 'EOF'
          cd coin_crab_server/uat
          echo "🔍 Checking UAT server status..."
          if [ -f server.pid ] && ps -p $(cat server.pid) > /dev/null 2>&1; then
            echo "UAT server is running with PID $(cat server.pid)"
            
            # Check if MQTT port is listening (UAT uses port 1882)
            if netstat -tuln | grep -q ":1882 "; then
              echo "UAT MQTT broker is listening on port 1882"
            else
              echo "UAT MQTT broker may not be listening on port 1882"
            fi
            
            # Show recent log entries
            echo "Recent UAT server logs:"
            tail -10 server.log
          else
            echo "UAT server is not running"
            echo "UAT server log:"
            cat server.log
            exit 1
          fi
        EOF

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()
    
    steps:
    - name: UAT Deployment Success
      if: needs.deploy.result == 'success'
      run: |
        echo "UAT deployment successful!"
        echo "UAT server deployed to AWS EC2: 100.26.107.175"
        echo "UAT MQTT broker should be available at: 100.26.107.175:1882"
        
    - name: UAT Deployment Failed
      if: needs.deploy.result == 'failure'
      run: |
        echo "UAT deployment failed!"
        echo "Check the deploy job logs for details"
        exit 1