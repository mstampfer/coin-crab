name: Deploy Server to AWS EC2

on:
  push:
    branches: [ main ]
    paths:
      - 'crates/server/**'
      - 'crates/shared/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  pull_request:
    branches: [ main ]
    paths:
      - 'crates/server/**'
      - 'crates/shared/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  workflow_dispatch:  # Enable manual trigger from GitHub UI

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Check workspace
      run: cargo check --workspace
      
    - name: Run server tests
      run: cargo test -p coin-crab-server --verbose
      
    - name: Run shared crate tests  
      run: cargo test -p shared --verbose
      
    - name: Build server for release
      run: |
        # Enable ARM64 architecture sources for cross-compilation
        sudo dpkg --add-architecture arm64
        sudo apt-get update
        
        # Install cross-compilation tools for ARM64 including OpenSSL
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          libssl-dev:arm64 \
          pkg-config \
          dpkg-dev
        
        # Set environment variables for cross-compilation with glibc
        export CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
        export CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++
        export AR_aarch64_unknown_linux_gnu=aarch64-linux-gnu-ar
        export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
        
        # Set OpenSSL environment variables for cross-compilation
        export PKG_CONFIG_ALLOW_CROSS=1
        export PKG_CONFIG_PATH="/usr/lib/aarch64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH"
        export OPENSSL_DIR=/usr
        export OPENSSL_LIB_DIR=/usr/lib/aarch64-linux-gnu
        export OPENSSL_INCLUDE_DIR=/usr/include/openssl
        
        # Add Rust target for ARM64 with glibc
        rustup target add aarch64-unknown-linux-gnu
        
        # Build for ARM64 
        cargo build -p coin-crab-server --release --target aarch64-unknown-linux-gnu
        
        # Debug: show binary info
        file target/aarch64-unknown-linux-gnu/release/coin-crab-server
        ls -la target/aarch64-unknown-linux-gnu/release/coin-crab-server
      
    - name: Upload server binary as artifact
      uses: actions/upload-artifact@v4
      with:
        name: coin-crab-server-binary
        path: target/aarch64-unknown-linux-gnu/release/coin-crab-server
        retention-days: 7

  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download server binary
      uses: actions/download-artifact@v4
      with:
        name: coin-crab-server-binary
        path: ./artifacts
        
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AWS_SSH_PRIVATE_KEY }}" > ~/.ssh/aws-freetier.pem
        chmod 600 ~/.ssh/aws-freetier.pem
        ssh-keyscan -H 100.26.107.175 >> ~/.ssh/known_hosts
        
    - name: Copy server files to EC2
      run: |
        # Create directory on EC2
        ssh -i ~/.ssh/aws-freetier.pem ec2-user@100.26.107.175 "mkdir -p coin_crab_server"
        
        # Copy binary
        scp -i ~/.ssh/aws-freetier.pem ./artifacts/coin-crab-server ec2-user@100.26.107.175:~/coin_crab_server/
        
        # Copy configuration files
        scp -i ~/.ssh/aws-freetier.pem crates/server/.env.server ec2-user@100.26.107.175:~/coin_crab_server/ || echo "No .env.server file found - you'll need to create it manually on the server"
        scp -i ~/.ssh/aws-freetier.pem crates/server/rumqttd.toml ec2-user@100.26.107.175:~/coin_crab_server/
        
    - name: Deploy and restart server
      run: |
        ssh -i ~/.ssh/aws-freetier.pem ec2-user@100.26.107.175 << 'EOF'
          cd coin_crab_server
          
          # Debug: Check system architecture and binary format
          echo "ğŸ” EC2 System Info:"
          uname -m
          file coin-crab-server
          
          # Make binary executable
          chmod +x coin-crab-server
          
          # Stop existing server if running
          pkill coin-crab-server || echo "No existing server process found"
          
          # Wait a moment for graceful shutdown
          sleep 2
          
          # Start server in background with nohup
          # Redirect output to log file
          nohup ./coin-crab-server > server.log 2>&1 &
          
          # Save PID for future management
          echo $! > server.pid
          
          # Wait a moment and check if server started
          sleep 3
          if ps -p $(cat server.pid) > /dev/null 2>&1; then
            echo "âœ… Server started successfully with PID $(cat server.pid)"
            echo "ğŸ“Š Server status:"
            ps -p $(cat server.pid) -o pid,ppid,cmd
          else
            echo "âŒ Server failed to start"
            echo "ğŸ“‹ Last 20 lines of server log:"
            tail -20 server.log
            exit 1
          fi
        EOF
        
    - name: Verify deployment
      run: |
        ssh -i ~/.ssh/aws-freetier.pem ec2-user@100.26.107.175 << 'EOF'
          cd coin_crab_server
          echo "ğŸ” Checking server status..."
          if [ -f server.pid ] && ps -p $(cat server.pid) > /dev/null 2>&1; then
            echo "âœ… Server is running with PID $(cat server.pid)"
            
            # Check if MQTT port is listening
            if netstat -tuln | grep -q ":1883 "; then
              echo "âœ… MQTT broker is listening on port 1883"
            else
              echo "âš ï¸  MQTT broker may not be listening on port 1883"
            fi
            
            # Show recent log entries
            echo "ğŸ“‹ Recent server logs:"
            tail -10 server.log
          else
            echo "âŒ Server is not running"
            echo "ğŸ“‹ Server log:"
            cat server.log
            exit 1
          fi
        EOF

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()
    
    steps:
    - name: Deployment Success
      if: needs.deploy.result == 'success'
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸš€ Server deployed to AWS EC2: 100.26.107.175"
        echo "ğŸ“¡ MQTT broker should be available at: 100.26.107.175:1883"
        
    - name: Deployment Failed
      if: needs.deploy.result == 'failure'
      run: |
        echo "âŒ Deployment failed!"
        echo "ğŸ” Check the deploy job logs for details"
        exit 1